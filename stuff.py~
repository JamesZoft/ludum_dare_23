#!/usr/bin/env python
import pygame
pygame.init()

class Vec2(object):
    
    def __init__(self, x, y):
        self.x = x
        self.y = y
    
    def add(self, b):
        return Vec2(self.x+b.x, self.y+b.y)
    
    def sub(self, b):
        return Vec2(self.x-b.x, self.y-b.y)

class Camera(object):
    
    def __init__(self, position, width, height):
        self.width = width
        self.height = height
        self.position = position
    def update(self, trackpos):
        self.position.x = trackpos.x - self.width/2

class Sprite(object):
    
    def __init__(self, position, imgname, ckey = None):
        self.position = position
        self.surface = pygame.image.load(+ imgname)
        self.surface.set_colorkey(ckey)
        self.surface.convert()

    def update(self):
        pass

    def draw(self, surface, trans = Vec2(0, 0)):
        pos = self.position.sub(trans)
        surface.blit(self.surface, (int(pos.x), int(pos.y)))

class Man(Sprite):

    def __init__(self, position):
        Sprite.__init__(self, position, "sprite_forwards.png", (255, 255, 255))
        self.velocity = Vec2(0, 0)
        self.floor = 300

    def update(self):
        self.velocity.y += 0.5
        self.position = self.position.add(self.velocity)
        if self.position.y > self.floor:
            self.position.y = self.floor
            self.velocity.y = 0

    def jump(self):
        if self.onGround():
            self.velocity.y = -15

    def onGround(self):
        return self.position.y == self.floor

    def stop(self):
        self.velocity.x = 0

    def goLeft(self):
        self.velocity.x = -10

    def goRight(self):
        self.velocity.x = 10


class Game(object):
    
    def __init__(self, screenx, screeny):
        self.screenx = screenx
        self.screeny = screeny
        self.camera = Camera(Vec2(0, 0), screenx, screeny)
        self.screen = None
        self.background = None
        self.man = None
    
    def handle_events(self):
        for e in pygame.event.get():
            if e.type == pygame.QUIT:
                self.running = 0
            elif e.type == pygame.KEYDOWN:
                if e.key == pygame.K_a:
                    self.man.goLeft()
                elif e.key == pygame.K_d:
                    self.man.goRight()
                elif e.key == pygame.K_SPACE:
                    self.man.jump()
            elif e.type == pygame.KEYUP:
                if e.key == pygame.K_a or e.key == pygame.K_d:
                    self.man.stop()

    def run(self):
        self.clock = pygame.time.Clock()
        self.screen = pygame.display.set_mode((self.screenx, self.screeny))

        self.background = Sprite(Vec2(0, 0), "tileset.png", (255, 255, 255))
        self.man = Man(Vec2(200, 200))

        self.running = 1
        while self.running:
            self.handle_events()
            self.man.update()
            self.camera.update(self.man.position)

            self.screen.fill((255,255,255))
            self.background.draw(self.screen, self.camera.position)
            self.man.draw(self.screen, self.camera.position)
            pygame.display.update()
            self.clock.tick(60)

def main():
    game = Game(800, 600)
    game.run()

if __name__ == '__main__':
    main()
